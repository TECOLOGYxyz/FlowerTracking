---
new_session: FALSE
title: |
  **Monitoring the phenology of individual flowers using deep learning and automatic tracking**
author:
- Hjalte M. R. Mann
- Alexandros Iosifidis
- Toke T. HÃ¸ye
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  word_document: default
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    latex_engine: pdflatex
  html_document:
    df_print: paged
fontfamily: mathpazo
fontsize: 12pt
geometry: margin = 1in
header-includes:
- \usepackage{setspace}\doublespacing
- \usepackage[left]{lineno}
- \linenumbers
- \usepackage{dcolumn}
- \usepackage{caption}
- \usepackage{float}
- \usepackage{afterpage}
- \usepackage{siunitx}
- \usepackage{amsmath}
keywords: Tracking, flowering phenology, Arctic, 
bibliography: ./library.bib
csl: ./journal-of-ecology.csl
abstract: ABSTRACT | Often simple variables will be used to describe the flowering phenology of a population of plants, e.g. onset or peak of flowering and to infer respones to climate change. Here we show that image-based monitoring of field plots at very high temporal resolution can return information on flowering phenology at the level of indiviuals. Further, we present an automatic flower tracking algorithm.
---

```{r eval = FALSE, echo=FALSE}
library(knitr)
knit('ManuscriptDraft.Rmd')
rmarkdown::render("ManuscriptDraft.Rmd", output_file = "ManuscriptDraft.docx")
system2("open","ManuscriptDraft.docx")
```




\newpage
**NOTES**


Online tracking:
SORT
DeepSORT


\pagebreak



# Introduction

* **Flowering phenology**
  + Importance of studying flowering phenology
  + Responses to climate change
  + Phenology of communities, populations, individuals
  + Traditional methods for studying
  + Onset of flowering says little about true distribution
    - Even true distribition of community says little about flowering lengths of individuals and for example how it varies accross the season.
  + Difficult to study at the individual level - requires high temporal resolution and keeping track of individuals
* **Image based monitoring**
  + Automatic, high temporal resolution, remote sites
  + High temporal resolution means that we can annotate individuals and get phenology of the individual

* **Tracking**
  + Offline and online
  + Online often coupled with CNNs that attempt to distinguish individuals from each other and recognize them through frames
  
  + Flowers appear very similar and 
  + Many methods for offline tracking
  + Hungarian/Kahlmann filter
  ++ May not be applicable for objects that move weirdly, e.g. change directions between frames.
  + Tracking based on distance.
    - Good but has some problems
    - Two points always associated disregarding absolute distance
    - Tracks lost when objects disappear
    - Objects close to each other may swap tracks

* **Our solution**
  + Here we demonstrate a framework for automatic flower tracking and evualutation of tracking performance
  + Ground truth tracks

\newpage

For the individual plant, timing of flowering is of utmost importance. Precocious flowering means that the plant has failed to exploit the whole temporal window for accumulating resources before allocating energy to flowering. On the other hand, flowering too late limit the time for reproduction before the end of the growing season [@ELZINGA2007]. Further, flowering may need to be synchronous with pollinator activity for successful reproduction. Flowering phenology may plastically change as a response to abiotic cues in the environment, such as timing of spring, temperature, and photoperiod, but variation in flowering phenology is partly heritable and shaped by selective forces from the abiotic and biotic environment.

Monitoring of flower phenology at high temporal resolution is laboursome and time-consuming, particularly in logistically challenging environment such as the Arctic. Consequently, simple variables are often used to represent the flowering phenology of a population, such as the date for onset of flowering, often derived from weekly observations of sample plots.

Automatic image-based monitoring of flowering phenology can return phenology data for specific species at very high temporal resolution (Mann et al., in prep).

For example, phenological responses at the individual level may be indiscernible regardless of the temporal resolution of the data at population level. For example, a shortening of flower longevity may not be directly obvious at the population level. Further, investigating the association between reproductive success and timing of flowering and flower longevity requires phenology data at the level of individuals.


Does flower visitation rates and/or reproductive success depend on the timing of flowering for the individual flower?









# Material and methods

## Study site



## The image series

## Flower annotations



We built a framework for tracking, filtering, and evaluating tracking of objects in time-lapse image series.

# Automatic tracking

Our algorithm tracks objects based on distances between centroids of bounding boxes. 

The tracking algorithm has a set of user adjusted parameters that can optimise tracking accuracy.

The parameters are particularly relevant for optimal tracking of objects that are constrained to a specific area such as flowers.

It is important to note, however, that the tracking algorithm can be used to track any objects.

The tracking algorithm can be applied both offline (on a set of detections/annotations that have already been produced) or online (real-time tracking frame per frame).

The speed of the tracking algorithm depends on the computational power available as well as the number of objects that are being tracked.


![](../figures/figure_1.png){ width=100% }

**Figure 1:** Simple centroid tracking may produce erronous associations when objects move between frames. Blue shows detections in the current frame (bounding box and centroid point). Red shows centroid points for the detections in the previous frame.



## User parameters

As the wind shifts, the flower heads changes direction. This can happen instantaneously (i.e. between two consecutive frames). As they are constrained by their stalk, there is a limit to the distance they can move.

Establishing associations between points based on just the distance between points in the current and the previous frame can cause errors when flowers are in close vicinity of each other.

![](../figures/figure_22.jpg){ width=100% }

The flowers move around a center point because of their stalk. We base the tracking on the distance between a point in the current frame and the running mean of the positions of the previous X points in a track.

As winds shift, flowers close to the edge of the frame may move in and out of view. If a flower reappears in the same area as a flower is already being tracked after disappearing in a few frames, it is a reasonable assumption that it is the same individual and not that the old flower wilted/disappeared and a new one developed. The parameter **max disappeared** sets the number of frames a track can be lost before a new track is initiated for points appearing in the same area.

![](../figures/figure_3.png){ width=100% }


Similarly, this deals with potential false negatives. If a given flower has not been annotated in a single frame, it should not be assigned a new track.

Setting **max disappeared** to 0 tracks objects based on the coordinates of the points in only the previous frame. The counter for number of disappeared frames is reset when a new point is associated with the track within the threshold.



# Evaluating tracking perfomance

Mota counts tracking mismatches (shifts in a track).


To derive flowering length, in theory we just need to track the most extreme points correctly and don't care about other points (although we filter by length when overlap).

To associate other information to the flower, for example flower visits, we want as much as possible of the track to be correct.

Lastly, we may be interested in the number of flowers that existed in a plot. Therefore, a final way of evaluating automatic flower tracking performance is to compare the number of tracks identified by the automatic tracking with the true number of flowers in a series. These should ideally be equal.

## Filtering tracks

Tracks that overlap have significant risk of errors. Overlapping tracks can be caused by a single flower that was erroneously assigned to several tracks, two flowers that were located sufficiently close to each other that there areas overlapped (e.g. when wind moves the flowers around), false positive detections close to a flower.Best case is two flowers that flowered in the same area but were separated by time. Here we will remove overlapping tracks to reduce the risk of error.

We disregard single points that were not associated to a track. For tracks consisting of two points, we establish the straight line between the points. For tracks consisting of three points, we establish the triangle from the points. For tracks consisting of more than three points, we calculate the convex hull of all the points included in the track and derive the polygon from the vertices of the convex hull.

We then check if any two lines intersect (for tracks with two points), if any lines intersect with any polygons, and if any polygons overlap with other polygons, and remove tracks that overlap.

We evaluate the accuracy of the remaining tracks.




# Results

One way to plot?: Time on x-axis, gt id on y axis, tr id as colour. This will show mismatches.



# Discussion

All three parameters make a difference.

In cases where we are tracking perfectly with maxDisap = 0, setting it any value will not make a difference. Not quite right. Explore more...



## Flower phenology



# Acknowledgements



# Data availability

The code that supports the results in this paper will be made openly available at https://github.com/TECOLOGYxyz/FlowerTracking. Raw data as well as the trained flower detection model will be archived on https://zenodo.org/.

\newpage
# References\
  




